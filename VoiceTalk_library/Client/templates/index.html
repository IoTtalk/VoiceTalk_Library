{% extends "base.html" %}

<!-- 在模板中填入 head 內容 -->
{% block head %}
<title>
    Voice Control
</title>

<style>
    /* 整個網頁占滿一個畫面的高度 */
    .container {
        height: 100vh;
        width: 100%;
        max-width: 900px;
    }

    .my-title-row {
        height: 10vh;
    }

    .my-response-row {
        height: 20vh;
    }

    .my-deviceinfo-row {
        height: 40vh;
        overflow-y: auto
    }

    #testing-button {
        /* background-image: url("https://fakeimg.pl/200x200/"); */
        background-image: url("{{ url_for('static', filename='images/typing.png') }}");
        height: 75%;
        width: 100%;
        background-size: 100%;
        max-height: 100px;
        max-width: 100px;
        background-repeat: no-repeat;
        background-position: center;
        float: left;
        /* margin: 0; */
    }

    #typing-button {
        /* background-image: url("https://fakeimg.pl/200x200/"); */
        background-image: url("{{ url_for('static', filename='images/typing.png') }}");
        height: 75%;
        width: 100%;
        background-size: 100%;
        max-height: 100px;
        max-width: 100px;
        background-repeat: no-repeat;
        background-position: center;
        float: left;
        /* margin: 0; */
    }

    #select-model-button {
        /* background-image: url("https://fakeimg.pl/200x200/"); */
        background-image: url("{{ url_for('static', filename='images/select_model.png') }}");
        height: 75%;
        width: 100%;
        background-size: 100%;
        max-height: 100px;
        max-width: 100px;
        background-repeat: no-repeat;
        background-position: center;
        float: left;
        /* margin: 0; */
    }

    .footer {
        /* border-top: 1px #a8c5f2 solid; */
        /* border-right: 1px #a8c5f2 solid; */
        /* border-left: 1px #a8c5f2 solid; */
        height: 25vh;
        width: 100%;
        max-width: 900px;
        margin: auto;
        /* background-color: #cfe2ff; */
    }

    .footer #footer-1st-row {
        height: 60%;
    }

    .footer #footer-2nd-row {
        height: 40%;
    }

    .footer .row .col-3 {
        height: 90%;
        display: flex;
        align-items: center;
        justify-content: space-around;
        padding: 2px;
    }

    .footer .wrapper {
        height: 100%;
        width: 100%;
        max-height: 135px;
        max-width: 100px;
    }

    .footer img,
    #selectLanguageButton {
        height: 75%;
        width: 100%;
        max-height: 100px;
        max-width: 100px;
        object-fit: scale-down;
        margin: 0;
        float: left;
    }

    .footer p {
        /* Safari/WebKit uses a non-standard name */
        width: intrinsic;
        /* Firefox/Gecko */
        width: -moz-max-content;
        /* Chrome */
        width: -webkit-max-content;
        width: max-content;
        /* background-color: aquamarine; */
        margin: auto;
        /* font-size: 1.4rem; */
    }
</style>
{% endblock %}

<!-- 在模板中填入 body 內容 -->
{% block body %}
<div class="container text-center my-1">
    <div class="row my-title-row">
        <div class="col">
            <h1 class="h3 fw-normal py-3 mb-0">VoiceTalk</h1>
        </div>
    </div>
    <div class="row my-response-row">
        <div class="col-12">
            <label id="recognitionTitle" for="recognitionBox">辨識結果:</label>
            <input id="recognitionBox" class="form-control" type="text" size="60" value="" />
        </div>
        <div class="col-12">
            <label id="responseTitle" for="recognitionBox">系統回覆:</label>
            <div id="resultarea">
                <input id="responseBox" class="form-control" size="60" readonly />
                <span id="response"></span>
            </div>
        </div>
    </div>
    {% for device in device_info_v2 %}
    {{device}}
    {% endfor %}
    <div class="row my-deviceinfo-row">
        <!-- html for Accordion ↓ -->
        <div class="container-12">
            <label id="deviceinfoTitle" for="recognitionBox">設備 & 指令提示:</label>
            <!-- <div class="row my-5 g-5 justify-content-around align-items-center"></div> -->
            <div class="accordion" id="accordionExample">
                {% for device in device_info %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading_{{loop.index}}">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse_{{loop.index}}" aria-expanded="true"
                            aria-controls="collapse_{{loop.index}}">
                            {{device}}
                        </button>
                    </h2>
                    <div id="collapse_{{loop.index}}"
                        class="accordion-collapse collapse {% if loop.index == 1 %}show{% endif %}"
                        aria-labelledby="heading_{{loop.index}}" data-bs-parent="#accordionExample">

                        <div class="accordion-body">
                            {% set rule1 = [] %}
                            {% set rule2 = [] %}

                            {% for info in device_info[device] %}
                            {% if info["rule"] == "1" %}
                            {% set _ = rule1.append(info) %}
                            {% elif info["rule"] == "2" %}
                            {% set _ = rule2.append(info) %}
                            {% endif %}
                            {% endfor %}

                            {% if rule1 != [] %}
                            <p>Rule 1 : <span style="color:red;">{{rule1[0]["value"][0]}}</span> the {{device}}</p>
                            <p>紅字可改成 : <span style="color:red;">{% for V in rule1[0]["value"] %}{{V}}, {% endfor
                                    %}</span></p>
                            {% endif %}
                            {% if rule2 != [] %}
                            <p>Rule 2 : Set the <span style="color:red;">{{rule2[0]["action"]}}</span> of the {{device}}
                                to <span style="color:blue;">{{rule2[0]["value"][0]}}</span>
                            </p>
                            <table class="table table-striped table-bordered table-sm">
                                <tr>
                                    <td>Action</td>
                                    <td>value</td>
                                </tr>
                                {% for info in rule2 %}
                                <tr>
                                    <td><span style="color:red;">{{info["action"]}}</span></td>
                                    <td><span style="color:blue;">{% for V in info["value"] %}{{V}}, {% endfor %}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </table>
                            {% endif %}

                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <!-- html for Accordion ↑ -->
    </div>

    <!-- Modal ↓ -->
    <!-- typing Modal -->
    <div class="modal fade" id="Modal_typing" tabindex="-1" aria-labelledby="Modal_typing_Label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="Modal_typing_Label">text input</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <input type="text" name="corrected_sentence" id="user_typing">
                        <!-- <input type="submit" name="send" value="文字送出"> -->
                        <button type="submit" id="submitBtn">Submit</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
                </div>
            </div>
        </div>
    </div>
    <!-- model switch Modal -->
    <div class="modal fade" id="Modal_model_switch" tabindex="-1" aria-labelledby="Modal_model_switch_Label"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="Modal_model_switch_Label">Model select</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <select id="selectASRtoolList" name="lang" onchange="changeASRtool(event)">
                    <option value="Web Speech API">Web Speech API</option>
                    <option value="Whisper">Whisper</option>
                    <option value="Dialogflow">Google Dialogflow</option>
                    <option value="STT">Google Speech-to-Text</option>
                </select>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
                </div>
            </div>
        </div>
    </div>
    <!-- Modal ↑ -->
    <div class="footer fixed-bottom">
        <div class="row justify-content-around align-items-center" id="footer-1st-row">
            <div class="col-3">
                <div class="wrapper">
                    <img id="startStopButton" onclick="startstopButton(event)"
                        src="{{ url_for('static', filename='images/start.gif') }}" />
                    <p id="infoBox">Voice</p>
                </div>
            </div>
        </div>
        <div class="row justify-content-around align-items-center" id="footer-2nd-row">
            <div class="col-3">
                <div class="wrapper">
                    <!-- Button trigger modal -->
                    <button type="button" id="typing-button" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#Modal_typing">
                    </button>
                    <p>Typing</p>
                </div>
            </div>
            <div class="col-3">
                <div class="wrapper">
                    <input type="image" id="selectLanguageButton" onclick="changeLanguage(event)" value="en-US"
                        src="{{ url_for('static', filename='images/en-US.png') }}" />
                    <p>Language</p>
                </div>
            </div>
            <div class="col-3 ">
                <div class="wrapper">
                    <!-- Button trigger modal -->
                    <button type="button" id="select-model-button" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#Modal_model_switch">
                    </button>
                    <p>model switch</p>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block script %}
<script type="text/javascript">
    $(document).ready(function () {
        checkWebSpeechAPI();
        startstopButton();
        changeLanguage();
    });
    //****************************************************************************************
    // 宣告變數
    //****************************************************************************************  
    var recognitionTitle = { "en-US": "Recognition Result", "cmn-Hant-TW": "辨識結果" }
    var recognitionBox = document.getElementById("recognitionBox"); // 辨識結果  "HTML元件"
    var final_transcript = '';
    var responseTitle = { "en-US": "System Response", "cmn-Hant-TW": "系統回覆" }
    var responseBox = document.getElementById("responseBox");     //系統回覆
    var deviceinfoTitle = { "en-US": "Devices and Command Prompt", "cmn-Hant-TW": "設備 & 指令提示" }
    var startStopButton; // 「開始/停止」按鈕
    var infoBox = document.getElementById("infoBox"); // 提示使用者的訊息
    var startMessage = { "en-US": "Tap to start", "cmn-Hant-TW": "按此開始" }
    var stopMessage = { "en-US": "Tap to stop", "cmn-Hant-TW": "按此結束" }
    var selectLanguageButton = document.getElementById("selectLanguageButton"); // 語言選擇的 input 圖片
    // var selectLanguageList = document.getElementById("selectLanguageList"); // 語言選擇的下拉式選單
    var recognizing = false; // 是否辨識中
    var using_tool = "Web Speech API";
    var selectASRtoolList = document.getElementById("selectASRtoolList"); // 語言選擇的下拉式選單
    var recognition;
    var microphone;
    var after_recognition_flag = false
    // var mediaRecorder;

    // testing execution time
    var start_time = 0
    var recognition_end_time = 0

    // 定義麥克風相關的函數
    let stream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    // 定義錄音相關功能
    // 在 async 中可以用 try...catch 來捕捉錯誤
    async function initRecorder() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            console.warn("MediaRecorder is already initialized and not inactive.");
            return;
        }
        // 清理之前的 recorder 和 stream
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        mediaRecorder = null;
        try {
            // 取得麥克風的存取權，取得後網頁就會顯示正在錄音的狀態
            stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            // 建立 MediaRecorder
            const options = { mimeType: 'audio/webm' };
            mediaRecorder = new MediaRecorder(stream, options);

            // 開始錄音時要做什麼
            mediaRecorder.onstart = function () {
                recordedChunks = []; // 清空已錄製的音訊片段
                recognizing = true;
                infoBox.innerText = stopMessage[language] // 提示使用者點選按鈕停止
                startStopButton.src = "{{ url_for('static', filename='images/start.gif') }}";
                console.log("Recording started.");
            }

            // 當有音訊數據就加到 recordedChunks 中
            mediaRecorder.ondataavailable = function (event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            console.log("MediaRecorder initialized.");
        } catch (err) {
            if (err.name === 'NotAllowedError') {
                console.error("Microphone access denied. Please allow microphone access in your browser settings.");
            } else {
                console.error("Error initializing MediaRecorder:", err);
            }
        }
    }
    // 開始錄音
    async function startRecording() {
        $("#recognitionBox").val(""); //清除最終的辨識訊息
        $("#responseBox").val("");    //清除系統回覆
        if (!mediaRecorder || mediaRecorder.state !== "inactive") {
            // 檢查 recorder 是否已初始化，若未初始化，則初始化
            // 雖然 initRecorder() 不是 Promise 寫法，但因為是宣告成 async 所以會自動把 return 包在 Promise 中回傳，所以可以用 await
            await initRecorder();
        }
        mediaRecorder.start();
    }
    // 停止錄音
    function stopRecording() {
        return new Promise(resolve => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.onstop = () => {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                    resolve(); // 在 onstop 事件中完成 Promise
                };
                mediaRecorder.stop();
                mediaRecorder = null;
                recognizing = false;
                infoBox.innerText = startMessage[language]  // 提示使用者點選按鈕開始
                startStopButton.src = "{{ url_for('static', filename='images/stop.jpg') }}";
                console.log("Recording stopped.");
            } else {
                resolve();
            }
        });
    }

    // 將資料(變數:data) 傳到後端的 route(變數:url)。
    // 使用 Promise 來處理非同步的操作，只需要搭配 .then() 跟 .catch() 就能接續處理，防止在還沒取得後端回覆前就執行後面的程式碼
    function process_sentence(url, data) {
        return new Promise((resolve, reject) => {
            $.getJSON({
                url: url,
                data: data,
                success: function (data) {
                    // 產生並顯示系統回覆
                    handlingSystemReplies(data)
                    // 將回傳到 'then'
                    resolve(data);
                },
                error: function () {
                    reject("Failed to get data from server"); // 如果失敗，調用 reject
                }
            });
        });
    }

    //=============== funtion changeLanguage(event) =======================
    // This function is triggered when clicking the change Language button
    // 1. stop the recognition and empty all the fields(recognition result,systme response)
    // 2. change the API's language setting
    // 3. change the language of context of GUI  
    // input: event driven  
    // output: recognition.lang is changed  

    function changeLanguage(event) {
        if (recognizing) { recognition.stop(); } //如果正在辨識, 就停止
        language = selectLanguageButton.value;
        if (language == "cmn-Hant-TW") { language = "en-US"; selectLanguageButton.src = "{{ url_for('static', filename='images/en-US.png') }}" }
        else if (language == "en-US") { language = "cmn-Hant-TW"; selectLanguageButton.src = "{{ url_for('static', filename='images/cmn-Hant-TW.png') }}" }
        console.log("change to", language);
        selectLanguageButton.value = language;

        $("#responseBox").val(""); //清空 系統回應
        $("#recognitionBox").val(""); //清空 HTML的辨識結果 “可視的元件”
        final_transcript = "";   //清空 API的辨識結果 "變數"

        recognition.lang = language;   //辨識API切換至當前語言
        $("#recognitionTitle").html(recognitionTitle[language]) // 辨識欄位的標題切換至當前語言
        $("#responseTitle").html(responseTitle[language])       // 回應欄位的標題切換至當前語言
        $("#deviceinfoTitle").html(deviceinfoTitle[language])   // 回應欄位的標題切換至當前語言
        infoBox.innerText = startMessage[language]              // 提示使用者的訊息切換至當前語言
    }

    //=============== funtion changeASRtool(event) =======================
    // This function is triggered when dropdown menu of ASR tools list is selected
    // 1. stop the recognition and empty all the fields(recognition result,systme response)
    // 2. change the ASR tools setting
    // input: event driven  
    // output: using_tool is changed  

    function changeASRtool(event) {
        if (recognizing) { recognition.stop(); } //如果正在辨識, 就停止
        using_tool = selectASRtoolList.options[selectASRtoolList.selectedIndex].value; // 取得被選擇的模型
        // if (language == "cmn-Hant-TW") { language = "en-US"; selectLanguageButton.src = "{{ url_for('static', filename='images/en-US.png') }}" }
        // else if (language == "en-US") { language = "cmn-Hant-TW"; selectLanguageButton.src = "{{ url_for('static', filename='images/cmn-Hant-TW.png') }}" }
        console.log("tool change to", using_tool);
        // if (using_tool == "Whisper") {
        //     initMicrophoneAndMediaRecorder();
        // }
    }


    // ===== startstopButton(event)  =================
    // This function is triggered when button on GUI is clicked
    // 1. get the language value from the dropdown list
    // 2. if system is recognizing, the button means stop, so stop the recognition
    // 3. if system is not recognizing, the button means start, so start the rocognition  
    async function startstopButton(event) {
        infoBox = document.getElementById("infoBox"); // 取得訊息控制項 infoBox
        recognitionBox = document.getElementById("recognitionBox"); // 取得最終的辨識訊息控制項 recognitionBox
        startStopButton = document.getElementById("startStopButton"); // 取得「辨識/停止」這個按鈕控制項
        // selectLanguageList = document.getElementById("selectLanguageList");
        // language = selectLanguageList.options[selectLanguageList.selectedIndex].value;
        language = selectLanguageButton.value;
        if (using_tool == "Web Speech API") {
            console.log("now is Web Speech API")
            if (recognizing) { // 如果正在辨識，則停止。
                recognition.stop();
                // // 若有需要使用後端回傳的資料，再把 process_sentence 後面的 .then 跟 .catch 打開來用
                // process_sentence(
                //     url = "/ProcessSentence", 
                //     data = { language: language, sentence: final_transcript }
                // )
            } else { // 否則就開始辨識
                $("#recognitionBox").val(""); //清除最終的辨識訊息
                $("#responseBox").val("");    //清除系統回覆
                final_transcript = ''; // 最終的辨識訊息變數
                recognition.lang = language //設定當前語言
                recognition.start(); // 開始辨識
            }
        }
        else {
            // 只有 web speech api 是自己處理出 ASR，其他三個工具(Whisper, DialogFlow, STT) 都是錄音檔傳到後端處理。
            if (recognizing) { // 如果正在辨識，則停止。
                await stopRecording();
                sendToBackend()
            }
            else {
                startRecording()
            }
        }
    }

    // 定義產生並顯示系統回復的 function
    function handlingSystemReplies(data) {
        if (language == "en-US") {
            console.log("data recieve", data)
            console.log("valid bit frontend", data.valid)
            if (data.valid < 0) {
                renderhtml = data.response
                switch (data.valid) {
                    case -1: renderhtml = "The number of device/device feature should be one, not multiple."; break;
                    case -2: renderhtml = "No device found in the sentence."; break;
                    case -3: renderhtml = "No device feature found in the sentence"; break;
                    case -4: renderhtml = "Device " + data.name + " does not support " + data.feature; break;
                    case -5: renderhtml = "The value" + data.value + " in sentence cause error"; break;
                }
            }
            else {
                if (data.valid == 1) {
                    // renderhtml = data.response + data.name + " is set to " + data.feature
                    renderhtml = data.response + data.name + " is set to " + data.value
                }
                else {
                    renderhtml = data.response + data.name + "'s " + data.feature + " is set to " + data.value
                }
            }
        }
        else if (language == "cmn-Hant-TW") {
            console.log("data recieve", data)
            console.log("valid bit frontend", data.valid)
            if (data.valid < 0) {
                renderhtml = data.response + data.valid
                switch (data.valid) {
                    case -1: renderhtml = "句子中的電器/電器功能的數量僅能為一個"; break;
                    case -2: renderhtml = "句子中未包含電器"; break;
                    case -3: renderhtml = "句子中未包含電器功能"; break;
                    case -4: renderhtml = data.name + " 不支援 " + data.feature; break;
                    case -5: renderhtml = "句子中的數值" + data.value + "有誤"; break;
                    case -6: renderhtml = "句子中的數值" + data.value + "超出範圍"; break;

                }
            }
            else {
                if (data.valid == 1) {
                    // renderhtml = data.response + data.name + "即將" + data.feature
                    renderhtml = data.response + data.name + "即將" + data.value
                }
                else {
                    renderhtml = data.response + data.name + "的" + data.feature + "將設定為" + data.value
                }
            }
        }
        console.log("renderhtml =", renderhtml)
        $("#responseBox").val(renderhtml);
    }

    // 定義 web speech api 的 function
    function checkWebSpeechAPI() {
        console.log("checking")
        // for web speech API
        if (!('webkitSpeechRecognition' in window)) {  // 如果找不到 window.webkitSpeechRecognition 這個屬性
            // 就是不支援語音辨識，要求使用者更新瀏覽器。 
            infoBox.innerText = "本瀏覽器不支援語音辨識，請更換瀏覽器！(Chrome 25 版以上才支援語音辨識)";
        }
        else {
            recognition = new webkitSpeechRecognition(); // 建立語音辨識物件 webkitSpeechRecognition
            recognition.continuous = true;                   // 設定連續辨識模式

            recognition.onstart = function () { // 開始辨識
                recognizing = true; // 設定為辨識中
                infoBox.innerText = stopMessage[language] // 提示使用者點選按鈕停止
                startStopButton.src = "{{ url_for('static', filename='images/start.gif') }}";
            };

            recognition.onend = function () { // 辨識完成
                recognizing = false; // 設定為「非辨識中」
                infoBox.innerText = startMessage[language]  // 提示使用者點選按鈕開始
                startStopButton.src = "{{ url_for('static', filename='images/stop.jpg') }}";
            };

            recognition.onresult = function (event) { // 辨識有任何結果時
                for (var i = event.resultIndex; i < event.results.length; ++i) { // 對於每一個辨識結果
                    if (event.results[i].isFinal) { // 如果是最終結果
                        final_transcript = event.results[i][0].transcript; // 將其加入最終結果中
                        console.log("i:" + i + event.results[i][0].transcript);
                    }
                }
                // testing execution time
                start_time = new Date().getTime();
                console.log("自動停止辨識 : " + start_time / 1000 + "sec");

                if (final_transcript.trim().length > 0) { // 如果有最終辨識文字
                    recognitionBox.value = final_transcript; // 顯示最終辨識文字到HTML

                    // 將辨識結果放到手動輸入欄位，讓使用者修改，再將 after_recognition_flag 設為 true
                    $("#user_typing").val(final_transcript);
                    after_recognition_flag = true

                    // 若有需要使用後端回傳的資料，再把 process_sentence 後面的 .then 跟 .catch 打開來用
                    process_sentence(
                        url = "/ProcessSentence",
                        data = { language: language, sentence: final_transcript }
                    )
                    // .then((data) => {
                    //     // process_sentence 成功會進到這裡， data 為後端回傳的資料
                    //     console.log("Received data: ", data);
                    // })
                    // .catch((error) => {
                    //     // process_sentence 失敗會進到這裡
                    //     console.error("Error: ", error);
                    // });
                    // portocol: send input to backend and get the input
                    // $.getJSON({
                    //     url: "/ProcessSentence",
                    //     data: { language: language, sentence: final_transcript },
                    //     success: function (data) {
                    //         // 產生並顯示系統回復
                    //         handlingSystemReplies(data)


                    //         // testing execution time
                    //         recognition_end_time = new Date().getTime();
                    //         console.log("recognition time (Web Speech API) : " + (recognition_end_time - start_time) / 1000 + "sec");
                    //     },
                    //     error: function () {
                    //         //alert("fail")
                    //     }
                    // });
                }
            };
        }
    }

    function sendToBackend() {
        let formData = new FormData();
        formData.append("using_tool", using_tool);
        // console.log("recordedChunks:", recordedChunks)
        formData.append("file", new Blob(recordedChunks), "audio.wav");

        let request = new XMLHttpRequest();
        // 先將音檔傳到後端("/save")跑 ASR，再將 ASR 結果傳到後端("/ProcessSentence")跑指令處理
        request.open("POST", "/save");
        request.onreadystatechange = () => {
            if (request.readyState == 4) {
                var res = JSON.parse(request.responseText);
                if (res.sentence != "") {
                    recognitionBox.value = res.sentence;
                    // 將辨識結果放到手動輸入欄位，讓使用者修改，再將 after_recognition_flag 設為 true
                    $("#user_typing").val(res.sentence);
                    after_recognition_flag = true

                    // 若有需要使用後端回傳的資料，再把 process_sentence 後面的 .then 跟 .catch 打開來用
                    process_sentence(
                        url = "/ProcessSentence",
                        data = { language: language, sentence: res.sentence }
                    )
                    // .then((data) => {
                    //     // process_sentence 成功會進到這裡， data 為後端回傳的資料
                    //     console.log("Received data: ", data);
                    // })
                    // .catch((error) => {
                    //     // process_sentence 失敗會進到這裡
                    //     console.error("Error: ", error);
                    // });
                }
            }
        }
        request.send(formData);
        console.log("傳送成功");
    };

    // 按下手動輸入的 Submit 按鈕
    $(document).ready(function () {
        $('form').submit(function (event) {
            var submitBtn = document.getElementById('submitBtn');
            event.preventDefault();
            corrected_sentence = $("#user_typing").val(),
                $("#user_typing").val("");
            submitBtn.disabled = true;
            submitBtn.textContent = "Waiting..."
            $.getJSON({
                type: 'POST',
                url: '/ManualTyping',
                data: {
                    language: language,
                    corrected_sentence: corrected_sentence,
                    wrong_sentence: $("#recognitionBox").val(),
                    after_recognition_flag: after_recognition_flag
                },
                // $('form').serialize() + "&wrong_sentence=" + $("#recognitionBox").val() + "&after_recognition_flag=" + after_recognition_flag,
                success: function (data) {
                    // 產生並顯示系統回復
                    handlingSystemReplies(data)
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Submit"
                    // 將使用者手動輸入內容放到 Recognition Result，並清空手動輸入欄位，再將 after_recognition_flag 設為 false
                    recognitionBox.value = corrected_sentence;
                    after_recognition_flag = false
                },
                error: function () {
                    alert("fail")
                }
            });
        });
    });
</script>
<!-- <script type="text/javascript">
    window.onload = startstopButton(event);
    window.onload = changeLanguage(event);
</script> -->
{% endblock %}